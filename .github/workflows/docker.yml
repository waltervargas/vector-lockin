name: Build, Push, and Deploy

on:
  push:
    branches: ['**']
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PERMITD_URL: https://apps.walt3r.dev
  API_VERSION: v5.4.2

jobs:
  build-and-push:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || format('preview/{0}', github.ref_name) }}
      url: https://${{ steps.vars.outputs.hostname }}

    steps:
      - name: Derive branch slug and container name
        id: vars
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

          BRANCH_REF="${GITHUB_REF#refs/heads/}"
          BRANCH_SLUG=$(echo "$BRANCH_REF" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
          CONTAINER_NAME="${REPO_OWNER}-${REPO_NAME}-${BRANCH_SLUG}"
          HOSTNAME="${REPO_OWNER}-${REPO_NAME}-${BRANCH_SLUG}.walt3r.dev"
          IMAGE_REF="ghcr.io/${{ github.repository }}:${{ needs.build-and-push.outputs.image-tag }}"

          echo "branch_slug=$BRANCH_SLUG" >> "$GITHUB_OUTPUT"
          echo "container_name=$CONTAINER_NAME" >> "$GITHUB_OUTPUT"
          echo "hostname=$HOSTNAME" >> "$GITHUB_OUTPUT"
          echo "image_ref=$IMAGE_REF" >> "$GITHUB_OUTPUT"

          echo "Branch slug: $BRANCH_SLUG"
          echo "Container: $CONTAINER_NAME"
          echo "Hostname: $HOSTNAME"
          echo "Image: $IMAGE_REF"

      - name: Get OIDC token
        id: oidc
        run: |
          TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=permitd" | jq -r '.value')
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Pull image
        env:
          IMAGE_REF: ${{ steps.vars.outputs.image_ref }}
        run: |
          echo "Pulling image: $IMAGE_REF"
          curl -sSf -X POST \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            "$PERMITD_URL/$API_VERSION/libpod/images/pull?reference=$IMAGE_REF"

      - name: Stop existing container
        env:
          CONTAINER_NAME: ${{ steps.vars.outputs.container_name }}
        run: |
          echo "Stopping container: $CONTAINER_NAME"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            "$PERMITD_URL/$API_VERSION/libpod/containers/$CONTAINER_NAME/stop")
          echo "Stop returned: $STATUS"
          if [ "$STATUS" != "204" ] && [ "$STATUS" != "304" ] && [ "$STATUS" != "404" ] && [ "$STATUS" != "500" ]; then
            echo "Unexpected status code: $STATUS"
            exit 1
          fi

      - name: Remove existing container
        env:
          CONTAINER_NAME: ${{ steps.vars.outputs.container_name }}
        run: |
          echo "Removing container: $CONTAINER_NAME"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            "$PERMITD_URL/$API_VERSION/libpod/containers/$CONTAINER_NAME?force=true")
          echo "Remove returned: $STATUS"
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "404" ]; then
            echo "Unexpected status code: $STATUS"
            exit 1
          fi

      - name: Create container
        env:
          CONTAINER_NAME: ${{ steps.vars.outputs.container_name }}
          IMAGE_REF: ${{ steps.vars.outputs.image_ref }}
          HOSTNAME: ${{ steps.vars.outputs.hostname }}
          BRANCH_SLUG: ${{ steps.vars.outputs.branch_slug }}
        run: |
          echo "Creating container: $CONTAINER_NAME on network apps"
          echo "Hostname: $HOSTNAME"
          curl -sSf -X POST \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "'"$CONTAINER_NAME"'",
              "image": "'"$IMAGE_REF"'",
              "env": {
                "NODE_ENV": "production"
              },
              "labels": {
                "traefik.enable": "true",
                "traefik.http.routers.'"$CONTAINER_NAME"'.rule": "Host(`'"$HOSTNAME"'`)",
                "traefik.http.services.'"$CONTAINER_NAME"'.loadbalancer.server.port": "3000",
                "app": "vector-lockin",
                "branch": "'"$BRANCH_SLUG"'"
              },
              "netns": {"nsmode": "bridge"},
              "networks": {
                "apps": {}
              },
              "restart_policy": "unless-stopped"
            }' \
            "$PERMITD_URL/$API_VERSION/libpod/containers/create"

      - name: Start container
        env:
          CONTAINER_NAME: ${{ steps.vars.outputs.container_name }}
        run: |
          echo "Starting container: $CONTAINER_NAME"
          curl -sSf -X POST \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            "$PERMITD_URL/$API_VERSION/libpod/containers/$CONTAINER_NAME/start"

      - name: Verify deployment
        env:
          CONTAINER_NAME: ${{ steps.vars.outputs.container_name }}
          HOSTNAME: ${{ steps.vars.outputs.hostname }}
        run: |
          echo "Checking container status..."
          curl -sSf \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            "$PERMITD_URL/$API_VERSION/libpod/containers/$CONTAINER_NAME/json" | \
            jq '{name: .Name, state: .State.Status, image: .ImageName}'
          echo ""
          echo "Deployed to: https://$HOSTNAME"
